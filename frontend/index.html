<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dekereke Sound File Association Tool</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header>
            <h1>Dekereke Sound File Association Tool</h1>
            <div id="status-bar">
                <span id="xml-status">No XML loaded</span>
                <span id="audio-status">No audio folder selected</span>
                <span id="record-count"></span>
            </div>
        </header>

        <!-- Main Navigation -->
        <nav id="main-nav">
            <button id="nav-setup" class="nav-btn active" data-step="setup">Initial Setup</button>
            <button id="nav-step1" class="nav-btn" data-step="step1" disabled>Step 1: Mapping</button>
            <button id="nav-step2" class="nav-btn" data-step="step2" disabled>Step 2: Conditions</button>
            <button id="nav-step3" class="nav-btn" data-step="step3" disabled>Step 3: Matching</button>
            <button id="nav-review" class="nav-btn" data-step="review" disabled>Review & Execute</button>
        </nav>

        <!-- Main Content Area -->
        <main id="main-content">
            <!-- Initial Setup Screen -->
            <section id="setup-screen" class="screen active">
                <h2>Initial Setup</h2>
                
                <div class="setup-section">
                    <h3>1. Select XML File</h3>
                    <button id="btn-select-xml" class="btn-primary">Select XML File</button>
                    <div id="xml-info" class="info-box hidden">
                        <p><strong>File:</strong> <span id="xml-path"></span></p>
                        <p><strong>Records:</strong> <span id="xml-record-count"></span></p>
                    </div>
                </div>

                <div class="setup-section">
                    <h3>2. Select Audio Folder</h3>
                    <button id="btn-select-audio" class="btn-primary">Select Audio Folder</button>
                    <div id="audio-info" class="info-box hidden">
                        <p><strong>Folder:</strong> <span id="audio-path"></span></p>
                        <p><strong>Files:</strong> <span id="audio-file-count"></span></p>
                    </div>
                </div>

                <div class="setup-section">
                    <h3>3. Case Sensitivity</h3>
                    <p>Is your file system case-sensitive?</p>
                    <p class="help-text">Most Windows and macOS systems are case-insensitive (file.wav = FILE.WAV). Linux is typically case-sensitive.</p>
                    <label>
                        <input type="radio" name="case-sensitive" value="false" checked> Case-insensitive (Windows/macOS default)
                    </label>
                    <label>
                        <input type="radio" name="case-sensitive" value="true"> Case-sensitive (Linux default)
                    </label>
                </div>

                <div id="duplicate-warning" class="warning-box hidden">
                    <h3>⚠️ Duplicate Reference Numbers Found</h3>
                    <p>The following Reference numbers appear multiple times:</p>
                    <div id="duplicate-list"></div>
                    <button id="btn-fix-duplicates" class="btn-warning">Fix Duplicates Now</button>
                    <button id="btn-skip-duplicates" class="btn-secondary">Continue Anyway</button>
                </div>

                <div id="empty-soundfile-warning" class="warning-box hidden">
                    <h3>⚠️ Empty SoundFile Elements Found</h3>
                    <p>Some records have empty &lt;SoundFile&gt; elements. These need to be filled before proceeding.</p>
                    <div id="empty-soundfile-list"></div>
                    <button id="btn-fill-soundfiles" class="btn-warning">Fill SoundFile Elements</button>
                    <button id="btn-skip-empty" class="btn-secondary">Skip These Records</button>
                </div>

                <div class="setup-section">
                    <button id="btn-proceed-to-step1" class="btn-primary btn-large" disabled>Proceed to Step 1</button>
                </div>
            </section>

            <!-- Step 1: Field-to-Suffix Mapping -->
            <section id="step1-screen" class="screen">
                <h2>Step 1: Field-to-Suffix Mapping</h2>
                <p>Map audio file suffixes to database fields. Drag suffixes from the left to fields on the right.</p>
                
                <div id="ambiguous-warning" class="warning-box hidden">
                    <h3>⚠️ Ambiguous Suffix Interpretations</h3>
                    <p>Some files could match multiple base filenames:</p>
                    <div id="ambiguous-list"></div>
                    <button id="btn-confirm-ambiguous" class="btn-primary">Confirm Interpretations</button>
                </div>

                <div class="button-row">
                    <button id="btn-load-dekereke-settings" class="btn-secondary">Load from Dekereke Settings</button>
                    <button id="btn-import-mappings" class="btn-secondary">Import Mappings</button>
                    <button id="btn-export-mappings" class="btn-secondary">Export Mappings</button>
                </div>

                <div class="mapping-container">
                    <div class="mapping-column">
                        <h3>Suffixes Found</h3>
                        <div id="suffix-list" class="draggable-list"></div>
                    </div>
                    <div class="mapping-column">
                        <h3>Database Fields</h3>
                        <div id="field-list" class="droppable-list"></div>
                    </div>
                </div>

                <div class="button-row">
                    <button id="btn-save-mappings" class="btn-primary">Save Mappings</button>
                    <button id="btn-proceed-to-step2" class="btn-primary" disabled>Proceed to Step 2</button>
                </div>
            </section>

            <!-- Step 2: Conditional Expectations -->
            <section id="step2-screen" class="screen">
                <h2>Step 2: Conditional Expectations</h2>
                <p>Define when recordings are expected for each field with mapped suffixes.</p>
                
                <div class="info-box">
                    <p><strong>Tip:</strong> Create rules to only expect recordings when certain conditions are met. For example, only expect incompletive aspect recordings for verbs.</p>
                </div>

                <div class="button-row">
                    <button id="btn-import-conditions" class="btn-secondary">Import Conditions</button>
                    <button id="btn-export-conditions" class="btn-secondary">Export Conditions</button>
                </div>

                <div id="conditions-container" class="conditions-tree"></div>

                <div class="button-row">
                    <button id="btn-save-conditions" class="btn-primary">Save Conditions</button>
                    <button id="btn-proceed-to-step3" class="btn-primary">Proceed to Step 3</button>
                </div>
            </section>

            <!-- Step 3: Matching Interface -->
            <section id="step3-screen" class="screen">
                <h2>Step 3: Match Files to Records</h2>
                
                <!-- Suggested Matches (only shown if matches found) -->
                <div id="step3-suggested" class="hidden">
                    <h3>Suggested Matches</h3>
                    <p>Review automatically suggested matches. Check the boxes for matches you want to accept.</p>
                    <div id="suggested-matches-list"></div>
                    <div class="button-row">
                        <button id="btn-accept-suggestions" class="btn-primary">Accept Selected</button>
                        <button id="btn-skip-suggestions" class="btn-secondary">Skip</button>
                    </div>
                    <hr style="margin: 2rem 0;">
                </div>

                <!-- Data Sheet View -->
                <div id="step3-datasheet">
                    <div class="datasheet-controls">
                        <button id="btn-column-settings" class="btn-secondary">Column Settings</button>
                        <button id="btn-toggle-filters" class="btn-secondary">Toggle Filters</button>
                        <button id="btn-clear-tentative" class="btn-secondary">Clear All Tentative</button>
                        <label style="display: inline-flex; align-items: center; gap: 0.5rem; margin-left: auto;">
                            <input type="checkbox" id="chk-auto-play" checked>
                            <span>Auto-play audio on click</span>
                        </label>
                    </div>
                    
                    <div class="datasheet-layout">
                        <!-- Main Data Sheet -->
                        <div class="datasheet-main">
                            <div id="datasheet-container" class="datasheet-scroll">
                                <table id="datasheet-table" class="datasheet-table">
                                    <thead id="datasheet-header"></thead>
                                    <tbody id="datasheet-body"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Orphaned Files Pane -->
                        <div class="orphaned-pane">
                            <h4>Orphaned Files <span id="orphaned-count" class="count-badge">0</span></h4>
                            <div id="orphaned-files-list" class="orphaned-list"></div>
                        </div>
                    </div>
                    
                    <!-- Filter Pane (collapsible bottom pane) -->
                    <div id="filter-pane" class="filter-pane hidden">
                        <div class="filter-header">
                            <h4>Filters</h4>
                            <button id="btn-clear-filters" class="btn-small">Clear All</button>
                        </div>
                        <div id="filter-conditions"></div>
                        <div class="button-row">
                            <button id="btn-apply-filters" class="btn-primary">Apply Filters</button>
                        </div>
                    </div>
                </div>

                <div class="button-row" style="margin-top: 1.5rem;">
                    <button id="btn-proceed-to-review" class="btn-primary">Proceed to Review</button>
                </div>
            </section>

            <!-- Review & Execute Screen -->
            <section id="review-screen" class="screen">
                <h2>Review Changes</h2>
                <p>Review all queued operations before applying them.</p>
                
                <div id="queue-summary">
                    <h3>Summary</h3>
                    <p><strong>Renames:</strong> <span id="rename-count">0</span></p>
                    <p><strong>Moves to Orphans:</strong> <span id="orphan-count">0</span></p>
                    <p><strong>Unrecorded:</strong> <span id="unrecorded-count">0</span></p>
                </div>

                <div id="queue-details">
                    <h3>Operations</h3>
                    <div id="operations-list"></div>
                </div>

                <div class="button-row">
                    <button id="btn-execute" class="btn-primary btn-large">Execute Operations</button>
                    <button id="btn-back-to-step3" class="btn-secondary">Back to Step 3</button>
                </div>
            </section>
        </main>

        <!-- Modals -->
        <div id="modal-overlay" class="modal-overlay hidden">
            <div id="modal-content" class="modal-content">
                <div id="modal-body"></div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="loading-overlay hidden">
            <div class="spinner"></div>
            <p id="loading-text">Processing...</p>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
